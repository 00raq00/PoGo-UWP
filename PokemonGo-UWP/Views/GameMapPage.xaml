<Page
    x:Class="PokemonGo_UWP.Views.GameMapPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:PokemonGo_UWP.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:maps="using:Windows.UI.Xaml.Controls.Maps"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:controls="using:WinRTXamlToolkit.Controls"
    DataContext="{Binding GameManagerViewModel, Source={StaticResource Locator}}"
    x:Name="GamePage"
    mc:Ignorable="d">

    <Page.Resources>

        <Storyboard x:Name="ShowPokeMenuStoryboard">
            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="TranslateY"
                From="-30"
                To="-300"
                Duration="0:0:0.2" />

            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="ScaleY"
                From="0"
                To="1"
                Duration="0:0:0.2" />

            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="ScaleX"
                From="0"
                To="1"
                Duration="0:0:0.2" />
        </Storyboard>

        <Storyboard x:Name="HidePokeMenuStoryboard">
            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="TranslateY"
                From="-300"
                To="-30"
                Duration="0:0:0.2" />

            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="ScaleY"
                From="1"
                To="0"
                Duration="0:0:0.2" />

            <DoubleAnimation
                Storyboard.TargetName="PokeButton1CompositeTransform"
                Storyboard.TargetProperty="ScaleX"
                From="1"
                To="0"
                Duration="0:0:0.2" />
        </Storyboard>

    </Page.Resources>

    <RelativePanel Background="Green">

        <maps:MapControl BusinessLandmarksVisible="False"
                         LandmarksVisible="False"
                         ColorScheme="Light"
                         DesiredPitch="50"
                         PedestrianFeaturesVisible="False"
                         TrafficFlowVisible="False"
                         TransitFeaturesVisible="False"
                         ZoomLevel="20"
                         RelativePanel.AlignTopWithPanel="True"
                         RelativePanel.AlignBottomWithPanel="True"
                         RelativePanel.AlignLeftWithPanel="True"
                         RelativePanel.AlignRightWithPanel="True"
                         Center="{Binding CurrentGeoposition.Coordinate.Point, Mode=TwoWay}"
                         MapServiceToken="{Binding MapServiceToken, Mode=OneTime}"
                         x:Name="MapControl">

            <Image Source="../Assets/UI/ash.png"
                   maps:MapControl.Location="{Binding CurrentGeoposition.Coordinate.Point}"
                   maps:MapControl.NormalizedAnchorPoint="0.5,1"
                   Stretch="Uniform"
                   Height="48"
                   Width="48" />

            <maps:MapItemsControl ItemsSource="{Binding CatchablePokemons}">
                <maps:MapItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Style="{ThemeResource ImageButtonStyle}"
                                CommandParameter="{Binding}"
                                Command="{Binding TryCatchPokemon, Source={Binding GameManagerViewModel, Source={StaticResource Locator}}}">
                            <Image Source="{Binding PokemonId, Converter={StaticResource PokemonIdToPokemonSpriteConverter}}"
                                   maps:MapControl.Location="{Binding Geoposition}"
                                   maps:MapControl.NormalizedAnchorPoint="0,1"
                                   Stretch="Uniform"
                                   Height="64"
                                   Width="64" />
                            
                            <!--<Ellipse Width="48"
                                     Height="48"
                                     Stroke="Green"
                                     StrokeThickness="2.5">
                                <Ellipse.RenderTransform>
                                    <CompositeTransform Rotation="50"
                                                        SkewX="25"
                                                        SkewY="-50"
                                                        TranslateX="-2.5"/>
                                </Ellipse.RenderTransform>
                            </Ellipse>-->
                            
                        </Button>
                    </DataTemplate>
                </maps:MapItemsControl.ItemTemplate>
            </maps:MapItemsControl>

        </maps:MapControl>

        <Grid RelativePanel.AlignBottomWithPanel="True"
              RelativePanel.AlignLeftWithPanel="True"
              RelativePanel.AlignRightWithPanel="True"
              Canvas.ZIndex="2"
              Height="110">
            <Grid.Background>
                <SolidColorBrush Color="{ThemeResource SystemAccentColor}"
                                 Opacity="0.35" />
            </Grid.Background>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="3*" />
            </Grid.ColumnDefinitions>

            <Grid x:Name="UserDetailsGrid"
                  Grid.Column="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Ellipse Grid.Column="0"
                         Width="48"
                         Height="48">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="../Assets/UI/avatar.png" />
                    </Ellipse.Fill>
                </Ellipse>

                <controls:Gauge Grid.Column="0"
                                Padding="5"
                                ScaleWidth="10"
                                Value="{Binding PlayerStats.Experience}"
                                Maximum="{Binding PlayerStats.NextLevelXp}"
                                ValueBrush="Transparent"
                                ScaleTickBrush="Transparent"
                                TickBrush="Transparent"
                                NeedleBrush="Transparent"
                                ScaleBrush="Gray"
                                TrailBrush="White" />

                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="8*" />
                        <RowDefinition Height="3*" />
                        <RowDefinition Height="8*" />
                    </Grid.RowDefinitions>

                    <Grid VerticalAlignment="Bottom"
                          Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Lv"
                                   FontFamily="../Assets/Fonts/Generica.otf#Generica"
                                   HorizontalAlignment="Left"
                                   VerticalAlignment="Bottom"
                                   FontSize="20"
                                   Grid.Column="0" />
                        <TextBlock Text="{Binding PlayerStats.Level}"
                                   FontFamily="../Assets/Fonts/Generica.otf#Generica"
                                   HorizontalAlignment="Right"
                                   VerticalAlignment="Bottom"
                                   Margin="5,0,5,-6"
                                   FontSize="40"
                                   Grid.Column="1"
                                   Style="{ThemeResource BodyTextBlockStyle}" />
                    </Grid>
                    <MenuFlyoutSeparator Grid.Row="1"
                                         Padding="0"
                                         Margin="0" />
                    <TextBlock Grid.Row="2"
                               Text="{Binding PlayerProfile.Username}"
                               FontSize="18"
                               FontFamily="../Assets/Fonts/Generica.otf#Generica" />
                </Grid>
            </Grid>

            <!-- Pokeball main button -->
            <Button Grid.Column="1"
                    Style="{ThemeResource ImageButtonStyle}"
                    Click="PokeMenuMainButton_OnClick"
                    x:Name="PokeMenuMainButton">
                <Button.RenderTransform>
                    <TranslateTransform Y="-40" />
                </Button.RenderTransform>
                <Image Source="../Assets/UI/Pokeball.png"
                       Stretch="Uniform"
                       HorizontalAlignment="Stretch" />
            </Button>

            <!-- Menu button #1 -->
            <Button Grid.Column="1"
                    Style="{ThemeResource ImageButtonStyle}"
                    RenderTransformOrigin="0.5,0.5"
                    x:Name="PokeMenuButton1">
                <Button.RenderTransform>
                    <CompositeTransform TranslateY="-40"
                                        ScaleX="0"
                                        ScaleY="0"
                                        x:Name="PokeButton1CompositeTransform" />
                </Button.RenderTransform>
                <Image Source="../Assets/UI/avatar.png"
                       Stretch="Uniform"
                       HorizontalAlignment="Stretch" />
            </Button>

            <Grid x:Name="NearbyPokemonGrid"
                  Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="Nearby"
                           FontSize="15"
                           FontFamily="../Assets/Fonts/Generica.otf#Generica"
                           TextAlignment="Center"
                           Margin="0,24,0,20" />

                <StackPanel Grid.Row="1"
                            HorizontalAlignment="Center"
                            Margin="0,-12,0,0"
                            Orientation="Horizontal">

                    <Image
                        Source="{Binding NearbyPokemons[0].PokemonId, Converter={StaticResource PokemonIdToPokemonSpriteConverter}}"
                        Stretch="UniformToFill"
                        VerticalAlignment="Center"
                        Width="48"
                        Height="48"
                        Margin="3,0" />

                    <Image
                        Source="{Binding NearbyPokemons[1].PokemonId, Converter={StaticResource PokemonIdToPokemonSpriteConverter}}"
                        Stretch="UniformToFill"
                        VerticalAlignment="Center"
                        Width="48"
                        Height="48"
                        Margin="3,0" />

                    <Image
                        Source="{Binding NearbyPokemons[2].PokemonId, Converter={StaticResource PokemonIdToPokemonSpriteConverter}}"
                        Stretch="UniformToFill"
                        VerticalAlignment="Center"
                        Width="48"
                        Height="48"
                        Margin="3,0" />
                </StackPanel>
            </Grid>
        </Grid>
    </RelativePanel>
</Page>